<html>
<head>
  <script src="/assets/js/jquery-2.1.4.min.js"></script>
  <script src="/assets/js/bootstrap.min.js"></script>
  <script src="/assets/js/highcharts-custom.js"></script>
  <script src="/assets/js/handlebars.runtime-v4.0.5.js"></script>

  <link href='/assets/styles/bootstrap.min.css' rel='stylesheet'>
  <script src="/assets/templates/templates.js"></script>
  <script src='/socket.io/socket.io.js'></script>
  <script src='/assets/js/inputUtilities.js'></script>
  <script src='/assets/js/loadModal.js'></script>
</head>
<body>
    <div class='container'>
        <div class='jumbotron'>
        <h2>Market Risk</h2>
            <p>
            This standalone app represents the best in class standard in modeling techniques.  The webserver is driven by NodeJS, an asyncronous IO programming language.  The market model itself is implemented in C++ with multi-threading for use across any number of cores.  Automatic differentation is in place to efficiently compute sensitivities.  The model is self-consistent: there is no arbitrage and all assumptions carry across all pricing functions.  
            </p>
        </div>
      <div id='main'>

      </div>
        <div id='andmore'>

      </div>
    </div>
    


</body>
<script>
    var socket = io();
    Handlebars.partials = Handlebars.templates;
    
    var assets=[{
        label:"Bond",
        value:0,
    },{
        label:"Euro Dollar Future",
        value:1
    },{
        label:"Bond Call (Zero Coupon)",
        value:3
    },{
        label:"Bond Put (Zero Coupon)",
        value:4
    },{
        label:"Bond Call (Coupon)",
        value:5
    },{
        label:"Bond Put (Coupon)",
        value:6
    },{
        label:"Caplet",
        value:7
    },{
        label:"Swap",
        value:8,
    },{
        label:"Swaption",
        value:9
    }];
    var assetParameters={
        "0":[{
            label:"Maturity (years)",
            id:"T",
            placeholder:"1"
        }],
        "1":[{
            label:"Maturity (years)",
            id:"T",
            placeholder:"1"
        },{
            label:"Floating Tenor (years)",
            id:"delta",
            placeholder:".25"
        }],
        "3":[{
            label:"Maturity (years)",
            id:"T",
            placeholder:"1"
        },{
            label:"Underlying Maturity (years)",
            id:"Tm",
            placeholder:"1.25"
        },{
            label:"Strike",
            id:"k",
            placeholder:".97"
        }],
        "4":[{
            label:"Maturity (years)",
            id:"T",
            placeholder:"1"
        },{
            label:"Underlying Maturity (years)",
            id:"Tm",
            placeholder:"1.25"
        },{
            label:"Strike",
            id:"k",
            placeholder:".97"
        }],
        "7":[{
            label:"Maturity (years)",
            id:"T",
            placeholder:"1"
        },{
            label:"Floating Tenor (years)",
            id:"delta",
            placeholder:".25"
        },{
            label:"Strike",
            id:"k",
            placeholder:".02"
        }],
        "8":[{
            label:"Maturity (years)",
            id:"T",
            placeholder:"1"
        },{
            label:"Floating Tenor (years)",
            id:"delta",
            placeholder:".25"
        },{
            label:"Swap Rate",
            id:"k",
            placeholder:".02"
        }],
        "9":[{
            label:"Maturity (years)",
            id:"T",
            placeholder:"1"
        },{
            label:"Floating Tenor (years)",
            id:"delta",
            placeholder:".25"
        },{
            label:"Underlying Maturity (years)",
            id:"Tm",
            placeholder:"6"
        },{
            label:"Strike",
            id:"k",
            placeholder:".03"
        }]
    }
    var chart;
    var hasbutton=false;
    var progressbar = Handlebars.templates['progressbar'];
    var form = Handlebars.templates['MarketRiskParameters'];
    var display = Handlebars.templates['largetext'];
    var parameters = Handlebars.templates['AssetParameters'];
    var modalBRS = Handlebars.templates['modal'];
    var modal=new loadModal(modalBRS);
    var $main=$('#main');
    var $andmore=$('#andmore');
    $main.html(progressbar({percent:100}));
    socket.emit("getYield");
    socket.on('data', function(data) {
        data=JSON.parse(data);
        console.log(data);
        var keys=Object.keys(data);
        if(keys[0]==='Spot'||keys[0]==='Forward'){
            createChart(data[keys[0]], keys[0]);
            if(!hasbutton){
                $main.append(form({assets:assets}));
                hasbutton=true;
            }
        }
        else if(keys[0]==='percent'){
            $('#progressBar').css("width", data.percent*100+'%');
        }
        else{
            loadHistogram(modal.interior[0], data['bins'], data['count']);
        }
    });
    getMC=function(){
        var valsToSubmit={};
        $('.form-control').each(function(num, element){
            $el=$(element);
            if($el.val()){
                valsToSubmit[$el.attr('id')]=parseFloat($el.val());
            }
            else{
                valsToSubmit[$el.attr('id')]=parseFloat($el.attr('placeholder'));
            }
        });
        modal.launch("Histogram of Price");
        modal.replaceInterior(progressbar({percent:100}));
        socket.emit("getMC", valsToSubmit);
    };
    function displayOptions(val){
        $andmore.html(parameters({parameter:assetParameters[val]}));
    }
    function loadHistogram(id, categories, values){
        var chrt = new Highcharts.Chart({
            chart: {    
                title:"",
                renderTo: id,
                type: 'column',
                marginRight: 10,
            },
            credits:false,
            plotOptions: {
                series: {
                    groupPadding: 0,
                    pointPadding: 0,
                    borderWidth: 0
                }
            },
            xAxis: {
                type: 'category',
                categories:categories
            },
            yAxis: {
                title: {
                    text: 'Value'
                },
                plotLines: [{
                    value: 0,
                    width: 1,
                    color: '#808080'
                }]
            },
            tooltip: {
               formatter: function() {
                    return Highcharts.numberFormat(this.value, 2, ".", ",");
                }
            },
            legend: {
                enabled: false
            },
            exporting: {
                enabled: false
            },
            series: [{
                name: 'Random data',
                data: values
            }]
        });
    }

    function createChart(chartData, name){
        if(chart){
            chart.addSeries({
                data:chartData,
                name:name
            });
        }
        else{
            chart=new Highcharts.Chart({
                credits:false,
                chart: {
                    type: 'spline',
                    renderTo: 'main',
                    zoomType: 'x'
                },
                title:{
                    text:"Spot and Forward Curves"
                },
                xAxis:{
                    type:'category'
                },
                legend:{
                    enabled:false
                },
                series:[{
                    data:chartData,
                    name:name
                }]
            });
        }
    }
</script>

</html>
